<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoDeli Mission 1 - Test Complet</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 30px 0; padding: 20px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.pending { background: #fff3cd; color: #856404; }
        .progress { background: #e9ecef; border-radius: 4px; height: 20px; margin: 10px 0; }
        .progress-bar { background: #007bff; height: 100%; border-radius: 4px; transition: width 0.3s; }
        .api-status { display: flex; align-items: center; gap: 10px; margin: 5px 0; }
        .api-status .dot { width: 10px; height: 10px; border-radius: 50%; }
        .api-status .dot.green { background: #28a745; }
        .api-status .dot.red { background: #dc3545; }
        .api-status .dot.yellow { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå± EcoDeli Mission 1 - Test Fonctionnel Complet</h1>
        <p>Test automatis√© de toutes les fonctionnalit√©s client selon le cahier des charges Mission 1</p>
        
        <div class="section">
            <h2>üìä √âtat des API</h2>
            <div id="apiStatus">
                <div class="api-status">
                    <div class="dot yellow"></div>
                    <span>Initialisation des tests...</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîê Phase 1: Authentification & Tutorial</h2>
            <button onclick="testAuthentication()">Tester l'authentification</button>
            <button onclick="testTutorial()">Tester le syst√®me de tutoriel</button>
            <div id="authResults"></div>
        </div>

        <div class="section">
            <h2>üìã Phase 2: Gestion des Annonces</h2>
            <button onclick="testCreateAnnouncement()">Cr√©er une annonce</button>
            <button onclick="testGetAnnouncements()">Lister les annonces</button>
            <div id="announcementResults"></div>
        </div>

        <div class="section">
            <h2>üõçÔ∏è Phase 3: Services et R√©servations</h2>
            <button onclick="testSearchServices()">Rechercher des services</button>
            <button onclick="testBookService()">R√©server un service</button>
            <div id="servicesResults"></div>
        </div>

        <div class="section">
            <h2>üí≥ Phase 4: Paiements</h2>
            <button onclick="testPayments()">Tester les paiements</button>
            <button onclick="testInvoices()">Tester les factures</button>
            <div id="paymentsResults"></div>
        </div>

        <div class="section">
            <h2>üì¶ Phase 5: Stockage</h2>
            <button onclick="testStorage()">Tester le stockage</button>
            <div id="storageResults"></div>
        </div>

        <div class="section">
            <h2>‚≠ê Phase 6: Avis et √âvaluations</h2>
            <button onclick="testReviews()">Tester les avis</button>
            <div id="reviewsResults"></div>
        </div>

        <div class="section">
            <h2>üéØ Test Complet Mission 1</h2>
            <button onclick="runFullTest()" style="background: #28a745; font-size: 16px; padding: 15px 30px;">üöÄ Lancer le Test Complet</button>
            <div class="progress" style="display: none;" id="progressContainer">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div id="fullTestResults"></div>
        </div>
    </div>

    <script>
        // Configuration
        const BASE_URL = window.location.origin;
        const API_BASE = BASE_URL + '/api/trpc';
        
        let testResults = {
            auth: false,
            announcements: false,
            services: false,
            payments: false,
            storage: false,
            reviews: false
        };

        // Utilitaires
        function updateApiStatus(message, type = 'yellow') {
            const status = document.getElementById('apiStatus');
            status.innerHTML = `
                <div class="api-status">
                    <div class="dot ${type}"></div>
                    <span>${message}</span>
                </div>
            `;
        }

        function showResult(containerId, title, content, success = true) {
            const container = document.getElementById(containerId);
            const statusClass = success ? 'success' : 'error';
            const statusText = success ? 'SUCCESS' : 'ERROR';
            
            container.innerHTML += `
                <div class="section ${statusClass}">
                    <h4>${title} - <span class="status ${statusClass}">${statusText}</span></h4>
                    <pre>${content}</pre>
                </div>
            `;
        }

        function updateProgress(percentage) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            progressContainer.style.display = 'block';
            progressBar.style.width = percentage + '%';
        }

        // Tests d'authentification
        async function testAuthentication() {
            updateApiStatus('Test authentification en cours...', 'yellow');
            
            try {
                // Test de v√©rification de session
                const sessionResponse = await fetch(`${API_BASE}/client.getProfile`);
                const sessionData = await sessionResponse.json();
                
                if (sessionData.error) {
                    throw new Error('Pas de session active - vous devez vous connecter d\\'abord');
                }
                
                testResults.auth = true;
                showResult('authResults', 'Authentification', 
                    `‚úÖ Session active d√©tect√©e\nUtilisateur: ${JSON.stringify(sessionData.result.data, null, 2)}`, 
                    true);
                updateApiStatus('Authentification r√©ussie', 'green');
                
            } catch (error) {
                showResult('authResults', 'Authentification', 
                    `‚ùå Erreur: ${error.message}\n\n‚ö†Ô∏è Vous devez vous connecter sur ${BASE_URL}/fr/login avec:\nEmail: jean.dupont@orange.fr\nPassword: password123`, 
                    false);
                updateApiStatus('Authentification √©chou√©e', 'red');
            }
        }

        async function testTutorial() {
            try {
                // Test du statut du tutoriel
                const response = await fetch(`${API_BASE}/clientTutorial.getTutorialStatus`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.json.message);
                }
                
                showResult('authResults', 'Syst√®me de Tutorial', 
                    `‚úÖ Statut du tutoriel r√©cup√©r√©\n${JSON.stringify(data.result.data, null, 2)}`, 
                    true);
                    
            } catch (error) {
                showResult('authResults', 'Syst√®me de Tutorial', 
                    `‚ùå Erreur: ${error.message}`, 
                    false);
            }
        }

        // Tests des annonces
        async function testCreateAnnouncement() {
            try {
                const testData = {
                    title: "Test Livraison Mission 1",
                    description: "Livraison de test pour validation Mission 1",
                    deliveryType: "EXPRESS",
                    pickupAddress: "123 Rue de la R√©publique, Lyon",
                    pickupCity: "Lyon",
                    pickupPostalCode: "69001",
                    deliveryAddress: "456 Avenue de la Libert√©, Lyon",
                    deliveryCity: "Lyon",
                    deliveryPostalCode: "69002",
                    packageType: "SMALL_PACKAGE",
                    estimatedWeight: 2.5,
                    suggestedPrice: 25.00,
                    priority: "NORMAL"
                };

                const response = await fetch(`${API_BASE}/clientAnnouncements.createAnnouncement`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ json: testData })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.json.message);
                }
                
                testResults.announcements = true;
                showResult('announcementResults', 'Cr√©ation d\\'Annonce', 
                    `‚úÖ Annonce cr√©√©e avec succ√®s\nID: ${data.result.data.data.id}\nTitre: ${data.result.data.data.title}\nStatut: ${data.result.data.data.status}`, 
                    true);
                    
            } catch (error) {
                showResult('announcementResults', 'Cr√©ation d\\'Annonce', 
                    `‚ùå Erreur: ${error.message}`, 
                    false);
            }
        }

        async function testGetAnnouncements() {
            try {
                const response = await fetch(`${API_BASE}/clientAnnouncements.getMyAnnouncements`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.json.message);
                }
                
                showResult('announcementResults', 'Liste des Annonces', 
                    `‚úÖ ${data.result.data.announcements.length} annonce(s) trouv√©e(s)\n${JSON.stringify(data.result.data, null, 2)}`, 
                    true);
                    
            } catch (error) {
                showResult('announcementResults', 'Liste des Annonces', 
                    `‚ùå Erreur: ${error.message}`, 
                    false);
            }
        }

        // Tests des services
        async function testSearchServices() {
            try {
                const response = await fetch(`${API_BASE}/clientServices.searchServices`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.json.message);
                }
                
                testResults.services = true;
                showResult('servicesResults', 'Recherche de Services', 
                    `‚úÖ ${data.result.data.services.length} service(s) trouv√©(s)\n${JSON.stringify(data.result.data, null, 2)}`, 
                    true);
                    
            } catch (error) {
                showResult('servicesResults', 'Recherche de Services', 
                    `‚ùå Erreur: ${error.message}`, 
                    false);
            }
        }

        async function testBookService() {
            showResult('servicesResults', 'R√©servation de Service', 
                `‚ö†Ô∏è Test de r√©servation non impl√©ment√© - n√©cessite un service existant`, 
                true);
        }

        // Tests des paiements
        async function testPayments() {
            try {
                const response = await fetch(`${API_BASE}/clientPayments.getPaymentHistory`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.json.message);
                }
                
                testResults.payments = true;
                showResult('paymentsResults', 'Historique des Paiements', 
                    `‚úÖ Paiements r√©cup√©r√©s\n${JSON.stringify(data.result.data, null, 2)}`, 
                    true);
                    
            } catch (error) {
                showResult('paymentsResults', 'Historique des Paiements', 
                    `‚ùå Erreur: ${error.message}`, 
                    false);
            }
        }

        async function testInvoices() {
            try {
                const response = await fetch(`${API_BASE}/clientPayments.getInvoices`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.json.message);
                }
                
                showResult('paymentsResults', 'Factures', 
                    `‚úÖ Factures r√©cup√©r√©es\n${JSON.stringify(data.result.data, null, 2)}`, 
                    true);
                    
            } catch (error) {
                showResult('paymentsResults', 'Factures', 
                    `‚ùå Erreur: ${error.message}`, 
                    false);
            }
        }

        // Tests de stockage
        async function testStorage() {
            try {
                const response = await fetch(`${API_BASE}/clientStorage.searchBoxes`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.json.message);
                }
                
                testResults.storage = true;
                showResult('storageResults', 'Recherche de Boxes', 
                    `‚úÖ Stockage test√©\n${JSON.stringify(data.result.data, null, 2)}`, 
                    true);
                    
            } catch (error) {
                showResult('storageResults', 'Recherche de Boxes', 
                    `‚ùå Erreur: ${error.message}`, 
                    false);
            }
        }

        // Tests des avis
        async function testReviews() {
            try {
                const response = await fetch(`${API_BASE}/clientReviews.getClientReviews`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.json.message);
                }
                
                testResults.reviews = true;
                showResult('reviewsResults', 'Avis Client', 
                    `‚úÖ Avis r√©cup√©r√©s\n${JSON.stringify(data.result.data, null, 2)}`, 
                    true);
                    
            } catch (error) {
                showResult('reviewsResults', 'Avis Client', 
                    `‚ùå Erreur: ${error.message}`, 
                    false);
            }
        }

        // Test complet
        async function runFullTest() {
            updateProgress(0);
            document.getElementById('fullTestResults').innerHTML = '';
            
            const tests = [
                { name: 'Authentification', func: testAuthentication, weight: 20 },
                { name: 'Tutorial', func: testTutorial, weight: 10 },
                { name: 'Cr√©ation d\\'annonce', func: testCreateAnnouncement, weight: 25 },
                { name: 'Liste des annonces', func: testGetAnnouncements, weight: 15 },
                { name: 'Recherche de services', func: testSearchServices, weight: 15 },
                { name: 'Paiements', func: testPayments, weight: 10 },
                { name: 'Stockage', func: testStorage, weight: 5 }
            ];
            
            let currentProgress = 0;
            
            for (const test of tests) {
                updateApiStatus(`Test en cours: ${test.name}`, 'yellow');
                await test.func();
                currentProgress += test.weight;
                updateProgress(currentProgress);
                await new Promise(resolve => setTimeout(resolve, 500)); // Pause entre tests
            }
            
            // R√©sultats finaux
            const successCount = Object.values(testResults).filter(result => result).length;
            const totalTests = Object.keys(testResults).length;
            const successRate = Math.round((successCount / totalTests) * 100);
            
            const finalResult = `
üéØ TEST MISSION 1 TERMIN√â

üìä R√©sultats:
- Tests r√©ussis: ${successCount}/${totalTests}
- Taux de r√©ussite: ${successRate}%

‚úÖ Fonctionnalit√©s valid√©es:
${Object.entries(testResults).map(([key, value]) => 
    `- ${key}: ${value ? '‚úÖ OK' : '‚ùå KO'}`
).join('\n')}

${successRate >= 80 ? 
    'üéâ MISSION 1 VALID√âE - L\\'API EcoDeli est fonctionnelle!' : 
    '‚ö†Ô∏è Des corrections sont n√©cessaires pour finaliser Mission 1'
}
            `;
            
            showResult('fullTestResults', 'Rapport Final Mission 1', finalResult, successRate >= 80);
            updateApiStatus(`Tests termin√©s - ${successRate}% de r√©ussite`, successRate >= 80 ? 'green' : 'red');
            updateProgress(100);
        }

        // Initialisation
        window.onload = function() {
            updateApiStatus('Interface de test charg√©e - Pr√™t pour les tests', 'green');
        };
    </script>
</body>
</html>