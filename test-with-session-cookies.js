#!/usr/bin/env node

/**
 * Test complet de l'API EcoDeli avec gestion des cookies de session Better-Auth
 * Corrige le probl√®me de transmission des cookies entre les requ√™tes
 */

const http = require('http');

const colors = {
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    reset: '\x1b[0m',
    bold: '\x1b[1m'
};

class SessionManager {
    constructor() {
        this.cookies = new Map();
    }

    // Extraire et stocker les cookies de session
    storeCookies(headers) {
        const setCookieHeaders = headers['set-cookie'];
        if (setCookieHeaders) {
            setCookieHeaders.forEach(cookieHeader => {
                const [cookiePair] = cookieHeader.split(';');
                const [name, value] = cookiePair.split('=');
                if (name && value) {
                    this.cookies.set(name.trim(), value.trim());
                }
            });
        }
    }

    // Obtenir la cha√Æne de cookies pour les requ√™tes
    getCookieHeader() {
        if (this.cookies.size === 0) return null;
        
        return Array.from(this.cookies.entries())
            .map(([name, value]) => `${name}=${value}`)
            .join('; ');
    }

    // V√©rifier si on a des cookies de session
    hasSessionCookies() {
        return this.cookies.has('ecodeli-session') || 
               this.cookies.has('better-auth.session_token') ||
               Array.from(this.cookies.keys()).some(key => key.includes('session'));
    }
}

async function makeRequest(method, path, body = null, sessionManager = null) {
    return new Promise((resolve, reject) => {
        const options = {
            hostname: 'localhost',
            port: 3000,
            path: path,
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'User-Agent': 'EcoDeli-Session-Test/1.0'
            },
            timeout: 10000
        };

        // Ajouter les cookies de session si disponibles
        if (sessionManager && sessionManager.hasSessionCookies()) {
            const cookieHeader = sessionManager.getCookieHeader();
            if (cookieHeader) {
                options.headers['Cookie'] = cookieHeader;
            }
        }

        if (body && typeof body === 'object') {
            body = JSON.stringify(body);
            options.headers['Content-Length'] = Buffer.byteLength(body);
        }

        const req = http.request(options, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
                try {
                    const jsonData = data ? JSON.parse(data) : {};
                    resolve({ 
                        statusCode: res.statusCode, 
                        data: jsonData, 
                        raw: data,
                        headers: res.headers
                    });
                } catch {
                    resolve({ 
                        statusCode: res.statusCode, 
                        data: { raw: data }, 
                        raw: data,
                        headers: res.headers
                    });
                }
            });
        });

        req.on('error', reject);
        req.on('timeout', () => {
            req.destroy();
            reject(new Error('Timeout'));
        });

        if (body) req.write(body);
        req.end();
    });
}

async function testCompleteWorkflow() {
    console.log(`${colors.bold}${colors.blue}üß™ Test complet EcoDeli avec gestion de session${colors.reset}`);
    console.log('========================================================\n');

    const sessionManager = new SessionManager();
    let passed = 0;
    let failed = 0;

    // 1. Test de sant√©
    console.log('1. üè• Test de sant√© du serveur...');
    try {
        const health = await makeRequest('GET', '/api/health');
        if (health.statusCode === 200) {
            console.log(`${colors.green}   ‚úÖ Serveur op√©rationnel${colors.reset}`);
            passed++;
        } else {
            console.log(`${colors.red}   ‚ùå Serveur non op√©rationnel (${health.statusCode})${colors.reset}`);
            failed++;
        }
    } catch (error) {
        console.log(`${colors.red}   ‚ùå Erreur: ${error.message}${colors.reset}`);
        failed++;
    }

    // 2. Authentification et r√©cup√©ration de session
    console.log('\n2. üîê Authentification client...');
    try {
        const loginResult = await makeRequest('POST', '/api/auth/login', {
            email: 'client-complete@test.com',
            password: 'Test123!'
        });

        if (loginResult.statusCode === 200 && loginResult.data.success) {
            console.log(`${colors.green}   ‚úÖ Authentification r√©ussie${colors.reset}`);
            
            // Stocker les cookies de session
            sessionManager.storeCookies(loginResult.headers);
            
            if (sessionManager.hasSessionCookies()) {
                console.log(`${colors.green}   ‚úÖ Cookies de session r√©cup√©r√©s${colors.reset}`);
                passed += 2;
            } else {
                console.log(`${colors.yellow}   ‚ö†Ô∏è Aucun cookie de session trouv√©${colors.reset}`);
                passed++;
                failed++;
            }
        } else {
            console.log(`${colors.red}   ‚ùå √âchec authentification: ${JSON.stringify(loginResult.data)}${colors.reset}`);
            failed += 2;
        }
    } catch (error) {
        console.log(`${colors.red}   ‚ùå Erreur authentification: ${error.message}${colors.reset}`);
        failed += 2;
    }

    // 3. Test session avec Better-Auth direct
    console.log('\n3. üç™ Test session Better-Auth...');
    try {
        const sessionResult = await makeRequest('GET', '/api/auth/session', null, sessionManager);
        
        if (sessionResult.statusCode === 200 && sessionResult.data.user) {
            console.log(`${colors.green}   ‚úÖ Session valide: ${sessionResult.data.user.email}${colors.reset}`);
            passed++;
        } else {
            console.log(`${colors.red}   ‚ùå Session invalide (${sessionResult.statusCode})${colors.reset}`);
            console.log(`   R√©ponse: ${JSON.stringify(sessionResult.data)}`);
            failed++;
        }
    } catch (error) {
        console.log(`${colors.red}   ‚ùå Erreur session: ${error.message}${colors.reset}`);
        failed++;
    }

    // 4. Test endpoints prot√©g√©s
    console.log('\n4. üõ°Ô∏è Test endpoints prot√©g√©s...');
    
    const protectedEndpoints = [
        { method: 'GET', path: '/api/client/dashboard', name: 'Dashboard client' },
        { method: 'GET', path: '/api/client/announcements', name: 'Annonces client' },
        { method: 'GET', path: '/api/client/services', name: 'Services client' }
    ];

    for (const endpoint of protectedEndpoints) {
        try {
            const result = await makeRequest(endpoint.method, endpoint.path, null, sessionManager);
            
            if (result.statusCode === 200) {
                console.log(`${colors.green}   ‚úÖ ${endpoint.name}: OK${colors.reset}`);
                passed++;
            } else if (result.statusCode === 401 || result.statusCode === 403) {
                console.log(`${colors.red}   ‚ùå ${endpoint.name}: Non autoris√© (${result.statusCode})${colors.reset}`);
                console.log(`   Debug: ${JSON.stringify(result.data)}`);
                failed++;
            } else {
                console.log(`${colors.yellow}   ‚ö†Ô∏è ${endpoint.name}: Status ${result.statusCode}${colors.reset}`);
                failed++;
            }
        } catch (error) {
            console.log(`${colors.red}   ‚ùå ${endpoint.name}: ${error.message}${colors.reset}`);
            failed++;
        }
    }

    // 5. Test cr√©ation d'annonce (si session valide)
    if (sessionManager.hasSessionCookies()) {
        console.log('\n5. üìù Test cr√©ation d\'annonce...');
        try {
            const announcementData = {
                title: "Test livraison urgente",
                description: "Test de cr√©ation d'annonce via API",
                pickupAddress: "1 Place de la R√©publique, 75003 Paris",
                deliveryAddress: "Tour Eiffel, 75007 Paris",
                packageType: "DOCUMENT",
                weight: 0.5,
                scheduledPickupDate: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(), // +2h
                maxDeliveryTime: 60,
                price: 15.00
            };

            const createResult = await makeRequest('POST', '/api/client/announcements', announcementData, sessionManager);
            
            if (createResult.statusCode === 201 || createResult.statusCode === 200) {
                console.log(`${colors.green}   ‚úÖ Annonce cr√©√©e avec succ√®s${colors.reset}`);
                
                if (createResult.data.id) {
                    console.log(`   ID: ${createResult.data.id}`);
                    passed++;
                    
                    // Test r√©cup√©ration de l'annonce cr√©√©e
                    try {
                        const getResult = await makeRequest('GET', `/api/client/announcements/${createResult.data.id}`, null, sessionManager);
                        if (getResult.statusCode === 200) {
                            console.log(`${colors.green}   ‚úÖ R√©cup√©ration annonce: OK${colors.reset}`);
                            passed++;
                        } else {
                            console.log(`${colors.red}   ‚ùå R√©cup√©ration annonce √©chou√© (${getResult.statusCode})${colors.reset}`);
                            failed++;
                        }
                    } catch (error) {
                        console.log(`${colors.red}   ‚ùå Erreur r√©cup√©ration: ${error.message}${colors.reset}`);
                        failed++;
                    }
                } else {
                    console.log(`${colors.yellow}   ‚ö†Ô∏è Annonce cr√©√©e mais sans ID${colors.reset}`);
                    passed++;
                }
            } else {
                console.log(`${colors.red}   ‚ùå Cr√©ation annonce √©chou√© (${createResult.statusCode})${colors.reset}`);
                console.log(`   Erreur: ${JSON.stringify(createResult.data)}`);
                failed++;
            }
        } catch (error) {
            console.log(`${colors.red}   ‚ùå Erreur cr√©ation annonce: ${error.message}${colors.reset}`);
            failed++;
        }
    } else {
        console.log(`\n5. ${colors.yellow}‚ö†Ô∏è Test annonce ignor√© (pas de session valide)${colors.reset}`);
        failed++;
    }

    // 6. Debug session
    console.log('\n6. üîç Debug session...');
    console.log(`   Cookies stock√©s: ${sessionManager.cookies.size}`);
    sessionManager.cookies.forEach((value, key) => {
        console.log(`   - ${key}: ${value.substring(0, 20)}...`);
    });

    // R√©sum√©
    console.log(`\n${colors.bold}üìä R√©sum√© des tests:${colors.reset}`);
    console.log(`${colors.green}‚úÖ R√©ussis: ${passed}${colors.reset}`);
    console.log(`${colors.red}‚ùå √âchou√©s: ${failed}${colors.reset}`);
    
    const total = passed + failed;
    const successRate = total > 0 ? Math.round((passed / total) * 100) : 0;
    
    if (successRate >= 70) {
        console.log(`\n${colors.green}${colors.bold}üéâ Tests majoritairement r√©ussis (${successRate}%)${colors.reset}`);
        
        if (failed > 0) {
            console.log(`\n${colors.blue}üí° Am√©liorations possibles:${colors.reset}`);
            console.log('1. V√©rifier la configuration Better-Auth dans src/lib/auth.ts');
            console.log('2. S\'assurer que les cookies httpOnly sont correctement configur√©s');
            console.log('3. V√©rifier les middlewares d\'autorisation dans les API routes');
            console.log('4. Tester avec le serveur de d√©veloppement red√©marr√©');
        }
    } else {
        console.log(`\n${colors.red}${colors.bold}üí• Probl√®mes critiques d√©tect√©s (${successRate}%)${colors.reset}`);
        console.log(`${colors.red}La gestion de session doit √™tre corrig√©e avant de continuer.${colors.reset}`);
    }
    
    return successRate >= 70;
}

// Lancement des tests
testCompleteWorkflow().then(success => {
    process.exit(success ? 0 : 1);
}).catch(error => {
    console.error(`${colors.red}Erreur critique:${colors.reset}`, error);
    process.exit(1);
});